<!--
  - SPDX-FileCopyrightText: 2024 Nextcloud GmbH and Nextcloud contributors
  - SPDX-License-Identifier: AGPL-3.0-or-later
  -->

<script setup lang="ts">
import { computed } from 'vue'
import { storeToRefs } from 'pinia'
import { t } from '@nextcloud/l10n'
import NcButton from '@nextcloud/vue/dist/Components/NcButton.js'
import NcCheckboxRadioSwitch from '@nextcloud/vue/dist/Components/NcCheckboxRadioSwitch.js'
import IconMagnify from 'vue-material-design-icons/Magnify.vue'
import IconMinus from 'vue-material-design-icons/Minus.vue'
import IconPlus from 'vue-material-design-icons/Plus.vue'
import NcNoteCard from '@nextcloud/vue/dist/Components/NcNoteCard.js'
import NcTextField from '@nextcloud/vue/dist/Components/NcTextField.js'
import IconRestore from 'vue-material-design-icons/Restore.vue'
import IconThemeLightDark from 'vue-material-design-icons/ThemeLightDark.vue'
import SettingsSubsection from './components/SettingsSubsection.vue'
import SettingsSelect from './components/SettingsSelect.vue'
import SettingsFormGroup from './components/SettingsFormGroup.vue'
import { useAppConfigValue } from './useAppConfigValue.ts'
import { useNcSelectModel } from '../composables/useNcSelectModel.ts'
import { useAppConfig } from './appConfig.store.ts'
import { ZOOM_MIN, ZOOM_MAX } from '../../../constants.js'
import locales from '../../../../resources/locales.json'

const { isRelaunchRequired } = storeToRefs(useAppConfig())

const theme = useAppConfigValue('theme')
const themeOptions = [
	{ label: t('talk_desktop', 'System default'), value: 'default' } as const,
	{ label: t('talk_desktop', 'Light'), value: 'light' } as const,
	{ label: t('talk_desktop', 'Dark'), value: 'dark' } as const,
]
const themeOption = useNcSelectModel(theme, themeOptions)

const systemTitleBar = useAppConfigValue('systemTitleBar')
const monochromeTrayIcon = useAppConfigValue('monochromeTrayIcon')
const spellCheckLanguages = useAppConfigValue('spellCheckLanguages')
const availableSpellCheckLanguages = ref<Set<string>>(new Set())

const zoomFactorConfig = useAppConfigValue('zoomFactor')
const zoomFactor = computed({
	get: () => zoomFactorConfig.value,
	set: (value: number) => {
		zoomFactorConfig.value = isFinite(value) ? Math.min(Math.max(value, ZOOM_MIN), ZOOM_MAX) : 1
	},
})
const zoomFactorPercentage = computed({
	get: () => Math.round(zoomFactor.value * 100).toString(),
	set: (value: string) => {
		zoomFactor.value = parseFloat(value) / 100
	},
})
const ZOOM_STEP = Math.sqrt(1.2)
const ctrl = window.OS.isMac ? 'Ctrl/Cmd' : 'Ctrl'
const zoomHint = t('talk_desktop', 'Zoom can be also changed by {key} or mouse wheel. Reset by {resetKey}', {
	key: `<kbd>${ctrl} + Â±</kbd>`,
	resetKey: `<kbd>${ctrl} + 0</kbd>`,
}, undefined, { escape: false })

window.TALK_DESKTOP.getAvailableSpellCheckerLanguages().then((languages: string[]) => {
	availableSpellCheckLanguages.value = new Set(languages.map((code) => code.replaceAll('_', '-')))
	console.log('availableSpellCheckLanguages', languages)
})

const langToSelectOption = (code: string) => ({ label: locales.find(locale => locale), value: code }))
}

const spellCheckLanguagesOptions = computed(() => [
		{ label: t('talk_desktop', 'System default'), value: 'default' },
		...locales
			.filter(({ code }) => availableSpellCheckLanguages.value.has(code))
			.map(({ code, name }) => ({ label: name, value: code })),
])
const selectedSpellCheckLanguagesOption = computed(() => {
	get() {
		return
	},
	set(value) {

	}
})

/**
 * Restart the app
 */
function relaunch() {
	window.TALK_DESKTOP.relaunchWindow()
}
</script>

<template>
	<div>
		<NcNoteCard v-if="isRelaunchRequired" type="info" class="relaunch-require-note-card">
			<div class="relaunch-require-note-card__content">
				<span>{{ t('talk_desktop', 'Some changes require a relaunch to take effect') }}</span>
				<NcButton type="primary"
					size="small"
					class="relaunch-require-note-card__button"
					@click="relaunch">
					{{ t('talk_desktop', 'Restart') }}
				</NcButton>
			</div>
		</NcNoteCard>

		<SettingsSubsection :name="t('talk_desktop', 'Appearance')">
			<SettingsSelect v-model="themeOption" :options="themeOptions" :label="t('talk_desktop', 'Theme')">
				<template #icon="{ size }">
					<IconThemeLightDark :size="size" />
				</template>
			</SettingsSelect>

			<NcCheckboxRadioSwitch :checked.sync="monochromeTrayIcon" type="switch">
				{{ t('talk_desktop', 'Use monochrome tray icon') }}
			</NcCheckboxRadioSwitch>

			<NcCheckboxRadioSwitch :checked.sync="systemTitleBar" type="switch">
				{{ t('talk_desktop', 'Use system title bar') }}
			</NcCheckboxRadioSwitch>

			<SettingsFormGroup :label="t('talk_desktop', 'Zoom')">
				<template #icon="{ size }">
					<IconMagnify :size="size" />
				</template>
				<template #description>
					<!-- eslint-disable-next-line vue/no-v-html -->
					<span v-html="zoomHint" />
				</template>
				<template #default="{ inputId, descriptionId }">
					<NcButton :aria-label="t('talk_desktop', 'Zoom out')" type="tertiary" @click="zoomFactor /= ZOOM_STEP">
						<template #icon>
							<IconMinus :size="20" />
						</template>
					</NcButton>
					<NcTextField :id="inputId"
						class="zoom-input"
						:aria-describedby="descriptionId"
						label-outside
						inputmode="number"
						:value="zoomFactorPercentage"
						@change="zoomFactorPercentage = $event.target.value"
						@blur="$event.target.value = zoomFactorPercentage" />
					<NcButton :aria-label="t('talk_desktop', 'Zoom in')" type="tertiary" @click="zoomFactor *= ZOOM_STEP">
						<template #icon>
							<IconPlus :size="20" />
						</template>
					</NcButton>
					<NcButton @click="zoomFactor = 1">
						<template #icon>
							<IconRestore :size="20" />
						</template>
						{{ t('talk_desktop', 'Reset') }}
					</NcButton>
				</template>
			</SettingsFormGroup>

			<SettingsSelect v-model="spellCheckLanguagesOption" :options="spellCheckLanguagesOptions" searchable tags>
				{{ t('talk_desktop', 'Spell check languages') }}
			</SettingsSelect>
		</SettingsSubsection>
	</div>
</template>

<style scoped>
.relaunch-require-note-card {
	margin-block-start: 0 !important;
}

.relaunch-require-note-card > :deep(div) {
	flex: 1; /* TODO: fix in upstream */
}

.relaunch-require-note-card__content {
	display: flex;
	gap: var(--default-grid-baseline);
	align-items: flex-start;
}

.relaunch-require-note-card__button {
	margin-inline-start: auto;
	flex: 0 0 auto;
}

.zoom-input {
	width: 50px !important;
}
</style>
